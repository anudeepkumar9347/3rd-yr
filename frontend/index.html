<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voice PD Detector</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23005588'/%3E%3Ctext x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='34' font-family='Arial' fill='white'%3EVD%3C/text%3E%3C/svg%3E" />
    <meta name="description" content="Minimal heuristic Parkinson's voice pattern demo" />
  </head>
  <body>
    <main>
      <header>
        <h1>Voice PD Detector</h1>
        <p class="subtitle">Upload (or drag & drop) a short WAV clip (speech). A simple heuristic extracts basic signal features and gives a rough label. Not a medical tool.</p>
      </header>

      <section class="panel grid" aria-label="Upload section">
        <div class="drop-zone" id="drop">
          <input id="file" type="file" accept="audio/*" aria-label="Audio file input" />
          <div class="cta">Drop audio file here or click to choose</div>
          <div class="hint">Most audio formats accepted (ffmpeg fallback). &lt;10s recommended.</div>
        </div>
        <div class="actions">
          <button id="analyze" disabled>Analyze</button>
          <button id="reset" class="secondary" disabled>Reset</button>
          <div class="badge" id="status">Idle</div>
        </div>
        <div id="result" aria-live="polite" aria-atomic="true">Waiting for audio...</div>
      </section>

      <footer>
        Demo only ‚Ä¢ No medical decisions ‚Ä¢ Backend: FastAPI heuristic
      </footer>
    </main>

    <script>
      const backendUrl = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://127.0.0.1:8000/predict'
        : 'http://127.0.0.1:8000/predict'; // Adjust if deployed elsewhere

      const el = (id) => document.getElementById(id);
      const fileInput = el('file');
      const drop = el('drop');
      const analyzeBtn = el('analyze');
      const resetBtn = el('reset');
      const resultBox = el('result');
      const statusBadge = el('status');

      let currentFile = null;

      function setStatus(text, cls) {
        statusBadge.textContent = text;
        statusBadge.className = 'badge' + (cls ? ' ' + cls : '');
      }

      function humanizeFeatures(f) {
        return {
          rms: { value: f.rms.toFixed(4), label: 'RMS Energy', description: 'Root Mean Square energy level' },
          zcr: { value: f.zcr.toFixed(4), label: 'Zero-Crossing Rate', description: 'Voice stability indicator' },
          pitch_var: { value: f.pitch_var.toFixed(2), label: 'Pitch Variance', description: 'Voice modulation variability' }
        };
      }

      function getConfidenceLevel(score) {
        if (score < 0.3) return 'low';
        if (score < 0.7) return 'medium';
        return 'high';
      }

      function getResultMessage(data) {
        const score = data.score * 100;
        const isPositive = data.label.includes('possible');
        
        if (isPositive) {
          if (score > 75) {
            return {
              title: '‚ö†Ô∏è High Confidence Detection',
              message: 'Strong indicators of Parkinson\'s-like voice patterns detected.',
              recommendation: 'Consider consulting a healthcare professional for proper medical evaluation.'
            };
          } else {
            return {
              title: '‚ö° Moderate Detection',
              message: 'Some Parkinson\'s-like voice patterns detected.',
              recommendation: 'Results are inconclusive. Consider additional testing if concerned.'
            };
          }
        } else {
          return {
            title: '‚úÖ No Strong Indicators',
            message: 'Voice patterns appear typical.',
            recommendation: 'No significant Parkinson\'s-like patterns detected in this sample.'
          };
        }
      }

      function createProgressBar(percentage) {
        return `
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%"></div>
          </div>
        `;
      }

      function renderResult(data) {
        const score = data.score * 100;
        const confidenceLevel = getConfidenceLevel(data.score);
        const result = getResultMessage(data);
        const features = humanizeFeatures(data.features);
        const labelClass = data.label.includes('possible') ? (data.score > 0.75 ? 'danger' : 'warn') : 'ok';
        
        resultBox.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="badge ${labelClass}">${data.label.replace(/_/g, ' ').toUpperCase()}</div>
              <span style="margin-left: auto; font-weight: bold; color: var(--text);">${score.toFixed(1)}%</span>
            </div>
            
            <h3 style="margin: 0 0 1rem 0; color: var(--text);">${result.title}</h3>
            <p style="color: var(--text-dim); margin-bottom: 1rem;">${result.message}</p>
            
            <div class="confidence-meter">
              <div class="confidence-fill ${confidenceLevel}" style="width: ${score}%"></div>
            </div>
            <small style="color: var(--text-dim);">Confidence Level: ${confidenceLevel.toUpperCase()}</small>
            
            <div class="audio-info">
              <div class="audio-info-item">
                <span class="audio-info-value">${data.sample_rate} Hz</span>
                <span class="audio-info-label">Sample Rate</span>
              </div>
              <div class="audio-info-item">
                <span class="audio-info-value">${data.channels}</span>
                <span class="audio-info-label">Channels</span>
              </div>
              <div class="audio-info-item">
                <span class="audio-info-value">${data.source_type}</span>
                <span class="audio-info-label">Source</span>
              </div>
            </div>
            
            <div class="features-grid">
              ${Object.entries(features).map(([key, feature]) => `
                <div class="feature-item">
                  <span class="feature-value">${feature.value}</span>
                  <span class="feature-label">${feature.label}</span>
                  <small style="color: var(--text-dim); margin-top: 0.5rem; display: block;">${feature.description}</small>
                </div>
              `).join('')}
            </div>
            
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,.03); border-radius: 8px; border-left: 3px solid var(--${confidenceLevel === 'high' ? 'danger' : confidenceLevel === 'medium' ? 'warn' : 'ok'});">
              <strong style="color: var(--text);">Recommendation:</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-dim);">${result.recommendation}</p>
            </div>
          </div>
        `;
      }

      function resetAll() {
        currentFile = null;
        fileInput.value = '';
        
        // Enhanced initial state
        resultBox.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="badge">READY</div>
            </div>
            <h3 style="margin: 0 0 1rem 0; color: var(--text);">üé§ Ready for Voice Analysis</h3>
            <p style="color: var(--text-dim); margin-bottom: 1rem;">
              Upload or drag & drop an audio file to begin Parkinson's voice pattern analysis.
            </p>
            <div style="padding: 1rem; background: rgba(255,255,255,.03); border-radius: 8px; border-left: 3px solid var(--grad-start);">
              <strong style="color: var(--text);">Supported formats:</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-dim);">
                Audio: MP3, WAV, FLAC, AAC, OGG<br>
                Video: MP4, AVI, MOV (audio will be extracted)<br>
                Maximum size: 10 MB
              </p>
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(251,191,36,.1); border-radius: 8px; border-left: 3px solid var(--warn);">
              <strong style="color: var(--warn);">‚ö†Ô∏è Important Disclaimer:</strong>
              <p style="margin: 0.5rem 0 0 0; color: var(--text-dim);">
                This is a demonstration tool using basic heuristics. Results are not medical diagnoses 
                and should not replace professional medical consultation.
              </p>
            </div>
          </div>
        `;
        
        analyzeBtn.disabled = true;
        resetBtn.disabled = true;
        setStatus('Idle');
      }

      resetBtn.addEventListener('click', resetAll);

      function acceptFile(f) {
        if (!f) return;
        
        // Enhanced file validation
        const maxSize = 10 * 1024 * 1024; // 10MB
        const supportedTypes = ['audio/', 'video/'];
        
        if (f.size > maxSize) {
          resultBox.innerHTML = `
            <div class="result-card">
              <div class="result-header">
                <div class="badge danger">FILE TOO LARGE</div>
              </div>
              <p style="color: var(--text-dim);">File size: ${(f.size / 1024 / 1024).toFixed(1)} MB</p>
              <p style="color: var(--danger);">Maximum allowed size is 10 MB. Please choose a smaller file.</p>
            </div>
          `;
          setStatus('Invalid','danger');
          return;
        }
        
        if (!supportedTypes.some(type => f.type.startsWith(type))) {
          resultBox.innerHTML = `
            <div class="result-card">
              <div class="result-header">
                <div class="badge warn">UNSUPPORTED FORMAT</div>
              </div>
              <p style="color: var(--text-dim);">File type: ${f.type || 'Unknown'}</p>
              <p style="color: var(--warn);">Please upload an audio or video file (MP3, WAV, MP4, etc.)</p>
            </div>
          `;
          setStatus('Invalid','warn');
          return;
        }
        
        currentFile = f;
        
        // Enhanced file info display
        const fileSize = f.size < 1024 ? `${f.size} B` : 
                        f.size < 1024 * 1024 ? `${(f.size / 1024).toFixed(1)} KB` :
                        `${(f.size / 1024 / 1024).toFixed(1)} MB`;
        
        resultBox.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="badge ok">FILE READY</div>
            </div>
            <h3 style="margin: 0 0 1rem 0; color: var(--text);">üìÅ ${f.name}</h3>
            <div class="audio-info">
              <div class="audio-info-item">
                <span class="audio-info-value">${fileSize}</span>
                <span class="audio-info-label">Size</span>
              </div>
              <div class="audio-info-item">
                <span class="audio-info-value">${f.type || 'Unknown'}</span>
                <span class="audio-info-label">Type</span>
              </div>
              <div class="audio-info-item">
                <span class="audio-info-value">${new Date(f.lastModified).toLocaleDateString()}</span>
                <span class="audio-info-label">Modified</span>
              </div>
            </div>
            <p style="color: var(--text-dim); margin-top: 1rem;">‚úÖ File validated and ready for analysis. Click "Analyze" to proceed.</p>
          </div>
        `;
        
        analyzeBtn.disabled = false;
        resetBtn.disabled = false;
        setStatus('Ready','ok');
      }

      fileInput.addEventListener('change', (e) => acceptFile(e.target.files[0]));

      ;['dragenter','dragover'].forEach(evt => {
        drop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
      });
      ;['dragleave','drop'].forEach(evt => {
        drop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
      });
      drop.addEventListener('drop', (e) => { const f = e.dataTransfer.files[0]; acceptFile(f); });
      drop.addEventListener('click', () => fileInput.click());

      analyzeBtn.addEventListener('click', async () => {
        if (!currentFile) return;
        const form = new FormData();
        form.append('file', currentFile);
        
        // Enhanced loading state
        resultBox.innerHTML = `
          <div class="result-card">
            <div class="result-header">
              <div class="badge warn">PROCESSING</div>
              <div class="loading-spinner"></div>
            </div>
            <h3 style="margin: 0 0 1rem 0; color: var(--text);">üî¨ Analyzing Audio...</h3>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 100%"></div>
            </div>
            <p style="color: var(--text-dim); margin-top: 1rem;">
              ‚Ä¢ Extracting audio features<br>
              ‚Ä¢ Calculating voice patterns<br>
              ‚Ä¢ Applying detection algorithms<br>
              ‚Ä¢ Generating confidence scores
            </p>
          </div>
        `;
        
        setStatus('Processing','warn');
        analyzeBtn.disabled = true;
        
        try {
          const res = await fetch(backendUrl, { method: 'POST', body: form });
          
          if (!res.ok) {
            let errText = `HTTP ${res.status}`;
            let rawBody = null;
            const clone = res.clone();
            
            try {
              const ct = res.headers.get('content-type') || '';
              if (ct.includes('application/json')) {
                const err = await res.json();
                rawBody = JSON.stringify(err);
                if (err.detail) errText += ` - ${err.detail}`;
              } else {
                rawBody = await res.text();
              }
            } catch (e) {
              rawBody = `<unreadable: ${e}>`;
            }
            
            console.error('[PredictError]', errText, 'body=', rawBody, 'headers=', [...clone.headers.entries()]);
            
            // Enhanced error display
            resultBox.innerHTML = `
              <div class="result-card">
                <div class="result-header">
                  <div class="badge danger">ERROR</div>
                </div>
                <h3 style="margin: 0 0 1rem 0; color: var(--danger);">‚ùå Analysis Failed</h3>
                <p style="color: var(--text-dim);">Error: ${errText}</p>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(239,68,68,.1); border-radius: 8px; border-left: 3px solid var(--danger);">
                  <strong style="color: var(--danger);">Troubleshooting:</strong>
                  <ul style="margin: 0.5rem 0 0 1rem; color: var(--text-dim);">
                    <li>Check if the backend server is running</li>
                    <li>Verify the audio file format is supported</li>
                    <li>Try a different audio file</li>
                    <li>Check console for detailed error information</li>
                  </ul>
                </div>
              </div>
            `;
            setStatus('Error','danger');
            return;
          }
          
          const data = await res.json();
          renderResult(data);
          setStatus('Complete', data.label.includes('possible') ? 'warn' : 'ok');
          
        } catch (err) {
          resultBox.innerHTML = `
            <div class="result-card">
              <div class="result-header">
                <div class="badge danger">NETWORK ERROR</div>
              </div>
              <h3 style="margin: 0 0 1rem 0; color: var(--danger);">üîå Connection Failed</h3>
              <p style="color: var(--text-dim);">Unable to connect to the analysis server.</p>
              <div style="margin-top: 1rem; padding: 1rem; background: rgba(239,68,68,.1); border-radius: 8px; border-left: 3px solid var(--danger);">
                <strong style="color: var(--danger);">Please check:</strong>
                <ul style="margin: 0.5rem 0 0 1rem; color: var(--text-dim);">
                  <li>Backend server is running on port 8000</li>
                  <li>Your internet connection</li>
                  <li>Firewall or antivirus blocking the connection</li>
                </ul>
                <p style="margin-top: 1rem; color: var(--text-dim);">Error details: ${err.message}</p>
              </div>
            </div>
          `;
          setStatus('Error','danger');
        } finally {
          analyzeBtn.disabled = false;
        }
      });

      // Initialize
      resetAll();
    </script>
  </body>
</html>
