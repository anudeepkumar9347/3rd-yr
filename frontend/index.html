<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voice PD Detector</title>
    <link rel="stylesheet" href="styles.css" />
    <meta name="description" content="Minimal heuristic Parkinson's voice pattern demo" />
  </head>
  <body>
    <main>
      <header>
        <h1>Voice PD Detector</h1>
        <p class="subtitle">Upload (or drag & drop) a short WAV clip (speech). A simple heuristic extracts basic signal features and gives a rough label. Not a medical tool.</p>
      </header>

      <section class="panel grid" aria-label="Upload section">
        <div class="drop-zone" id="drop">
          <input id="file" type="file" accept="audio/wav" aria-label="WAV file input" />
          <div class="cta">Drop WAV file here or click to choose</div>
          <div class="hint">16-bit PCM mono/stereo recommended. Short samples (&lt;10s) work best.</div>
        </div>
        <div class="actions">
          <button id="analyze" disabled>Analyze</button>
          <button id="reset" class="secondary" disabled>Reset</button>
          <div class="badge" id="status">Idle</div>
        </div>
        <div id="result" aria-live="polite" aria-atomic="true">Waiting for audio...</div>
      </section>

      <footer>
        Demo only • No medical decisions • Backend: FastAPI heuristic
      </footer>
    </main>

    <script>
      const backendUrl = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://127.0.0.1:8000/predict'
        : 'http://127.0.0.1:8000/predict'; // Adjust if deployed elsewhere

      const el = (id) => document.getElementById(id);
      const fileInput = el('file');
      const drop = el('drop');
      const analyzeBtn = el('analyze');
      const resetBtn = el('reset');
      const resultBox = el('result');
      const statusBadge = el('status');

      let currentFile = null;

      function setStatus(text, cls) {
        statusBadge.textContent = text;
        statusBadge.className = 'badge' + (cls ? ' ' + cls : '');
      }

      function humanizeFeatures(f) {
        const lines = [
          `RMS: ${f.rms.toFixed(4)}`,
          `Zero-Crossing Rate: ${f.zcr.toFixed(4)}`,
          `Pitch Variance: ${f.pitch_var.toFixed(2)}`,
        ];
        return lines.join('\n');
      }

      function renderResult(data) {
        const labelClass = data.label.includes('possible') ? (data.score > 0.75 ? 'danger' : 'warn') : 'ok';
        resultBox.innerHTML = '' +
          `<div class="badge ${labelClass}">${data.label}</div>` +
          `Score: ${(data.score * 100).toFixed(1)}%\n` +
          `\nFeatures:\n${humanizeFeatures(data.features)}`;
      }

      function resetAll() {
        currentFile = null;
        fileInput.value = '';
        resultBox.textContent = 'Waiting for audio...';
        analyzeBtn.disabled = true;
        resetBtn.disabled = true;
        setStatus('Idle');
      }

      resetBtn.addEventListener('click', resetAll);

      function acceptFile(f) {
        if (!f) return;
        if (!f.name.toLowerCase().endsWith('.wav')) {
          resultBox.textContent = 'Please select a .wav file.';
          setStatus('Invalid','danger');
          return;
        }
        currentFile = f;
        resultBox.textContent = `Selected: ${f.name} (${(f.size/1024).toFixed(1)} KB)`;
        analyzeBtn.disabled = false;
        resetBtn.disabled = false;
        setStatus('Ready','ok');
      }

      fileInput.addEventListener('change', (e) => acceptFile(e.target.files[0]));

      ;['dragenter','dragover'].forEach(evt => {
        drop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
      });
      ;['dragleave','drop'].forEach(evt => {
        drop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
      });
      drop.addEventListener('drop', (e) => { const f = e.dataTransfer.files[0]; acceptFile(f); });
      drop.addEventListener('click', () => fileInput.click());

      analyzeBtn.addEventListener('click', async () => {
        if (!currentFile) return;
        const form = new FormData();
        form.append('file', currentFile);
        resultBox.classList.add('loading');
        setStatus('Processing','warn');
        try {
          const res = await fetch(backendUrl, { method: 'POST', body: form });
          const data = await res.json();
          renderResult(data);
          setStatus('Done', data.label.includes('possible') ? 'warn' : 'ok');
        } catch (err) {
          resultBox.textContent = 'Error: ' + err;
          setStatus('Error','danger');
        } finally {
          resultBox.classList.remove('loading');
        }
      });

      // Initialize
      resetAll();
    </script>
  </body>
</html>
